<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Puzzel Chat Widget (Puzzel-only)</title>
  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;}
    #pzl-widget-container{position:relative;width:100%;height:100vh;}
    iframe{position:absolute;top:0;left:0;width:100% !important;height:100% !important;border:none;}
    #status{
      position:fixed;left:12px;top:12px;z-index:9999;background:rgba(255,255,255,0.95);
      padding:8px 10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    }
  </style>
</head>
<body>
  <div id="status">Loading Puzzel Information...</div>
  <div id="pzl-widget-container"></div>
  <script type="text/javascript" src="puzzel-api.min.js"></script>
  <script>
  (function () {
    const CUSTOMER_ID = "99201";
    const CONTAINER_ID = "pzl-widget-container";
    const statusEl = document.getElementById("status");
    let puzzelInitialized = false;

    async function main() {
      try {
        statusEl.textContent = "Initializing...";

        const maxWait = 5000;
        const startTime = Date.now();
        while (typeof widgetApiLib === "undefined" || typeof widgetApiLib.connect !== "function") {
          if (Date.now() - startTime > maxWait) {
            throw new Error("widgetApiLib.connect() not available. This page must be opened inside Puzzel.");
          }
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        statusEl.textContent = "Connecting to Puzzel...";
        const api = await widgetApiLib.connect();

        statusEl.textContent = "Fetching agent/auth info...";
        const puzzelApis = [
          "agent.firstName",
          "agent.lastName",
          "agent.userName",
          "agent.currentProfile",
          "auth.userName",
          "auth.userId",
          "auth.customerKey",
          "auth.customerId"
        ];

        const results = await Promise.all(puzzelApis.map((k) => api.get(k).catch(() => null)));
        const puzzel_info = {};
        results.forEach((result, index) => {
          puzzel_info[puzzelApis[index]] = result;
        });

        statusEl.textContent = "Loading Puzzel chat widget...";

        const loader = document.createElement("script");
        loader.type = "text/javascript";
        loader.src = "https://app-cdn.puzzel.com/public/js/pzl_loader.js";
        loader.setAttribute("id", "pzlModuleLoader");
        loader.setAttribute("data-customer-id", CUSTOMER_ID);
        loader.setAttribute("data-container", CONTAINER_ID);

        loader.onload = function () {
          const checkPzlReady = setInterval(() => {
            if (window.pzl && window.pzl.api) {
              clearInterval(checkPzlReady);
              puzzelInitialized = true;

              window.pzl.api.setClaims({
                full_context: puzzel_info,
                user_email: puzzel_info["auth.userName"] || puzzel_info["agent.userName"],
                puzzel_info: puzzel_info
              });

              statusEl.textContent = "";

              window.addEventListener("resize", () => {
                if (window.pzl && window.pzl.api && typeof window.pzl.api.resize === "function") {
                  window.pzl.api.resize();
                }
              });
            }
          }, 100);

          setTimeout(() => {
            if (!puzzelInitialized) {
              clearInterval(checkPzlReady);
              statusEl.textContent = "Warning: Puzzel chat widget did not initialize within expected time.";
            }
          }, 10000);
        };

        loader.onerror = function () {
          statusEl.textContent = "Error: Failed to load Puzzel chat widget loader.";
        };

        document.body.appendChild(loader);

      } catch (error) {
        console.error("Puzzel-only flow failed:", error);
        statusEl.textContent = "This page must be opened inside Puzzel. Check console for details.";
      }
    }

    main();

    setTimeout(() => {
      if (!puzzelInitialized) {
        const message = document.createElement("div");
        message.style.position = "absolute";
        message.style.left = "16px";
        message.style.top = "60px";
        message.style.right = "16px";
        message.style.background = "rgba(255,255,255,0.95)";
        message.style.padding = "12px";
        message.style.borderRadius = "8px";
        message.style.fontFamily = "system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial";
        message.innerHTML = "<strong>Puzzel-only widget</strong><div style='margin-top:8px'>Open this page inside the Puzzel app. If you see this message inside Puzzel, check console logs.</div>";
        document.body.appendChild(message);
      }
    }, 12000);
  })();
  </script>
</body>
</html>

